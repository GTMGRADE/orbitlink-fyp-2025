<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project SNA - OrbitLink</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #1e3167; /* Same blue as dashboard/landing */
        color: white;
        min-height: 100vh;
      }

      /* Unified Layout - Matching Dashboard */
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: 100vh;
      }

      /* Sidebar - More Compact (Matching Dashboard) */
      .sidebar {
        background: #f24822; /* Same orange */
        padding: 1.2rem 0.8rem;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        position: relative;
      }

      /* Brand - More Compact, Aligned with Dashboard */
      .brand-section {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.8rem;
        margin-bottom: 0.2rem;
      }

      .brand {
        font-size: 1.9rem;
        font-weight: bold;
        color: black;
        line-height: 1;
      }

      /* Create Button - More Compact (Matching Dashboard) */
      .create-btn {
        background: #14294a;
        color: white;
        border-radius: 10px;
        padding: 0.9rem 0.8rem;
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .create-btn:hover {
        background: #0f1c3d;
        transform: translateY(-1px);
      }

      /* Menu - Moved Higher (Matching Dashboard) */
      .menu {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.3rem;
      }

      .menu a {
        display: block;
        padding: 0.75rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
      }

      .menu a.active {
        background: rgba(255, 255, 255, 0.22);
        border-color: rgba(255, 255, 255, 0.15);
      }

      .menu a:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(3px);
      }

      /* Main Content Area - Matching Dashboard Blue */
      .content {
        background: #1e3167;
        padding: 1.5rem 2rem;
      }

      /* Header - More Compact, Better Alignment (Matching Dashboard) */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.2rem;
        padding-bottom: 0.8rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .title {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        letter-spacing: 0.3px;
        line-height: 1;
        padding-top: 0.2rem;
      }

      .profile-btn {
        text-decoration: none;
        color: black;
        font-weight: 700;
        padding: 0.7rem 1.5rem;
        background: #ff3333;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 0.95rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        line-height: 1;
        height: fit-content;
        margin-top: 0.2rem;
      }

      .profile-btn:hover {
        background: #cc0000;
        color: white;
        transform: translateY(-2px);
      }

      .profile-btn:active {
        transform: translateY(0);
      }

      /* Main Container - Matching Dashboard Style */
      .container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-width: 1200px;
        margin: 0 auto;
      }

      /* URL Input Section - Cleaner Design */
      .url-input-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .input-header {
        text-align: center;
        margin-bottom: 1.5rem;
      }

      .input-header h3 {
        font-size: 1.4rem;
        color: white;
        margin-bottom: 0.8rem;
        font-weight: 700;
      }

      .input-header p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1rem;
        line-height: 1.5;
        max-width: 600px;
        margin: 0 auto;
      }

      .input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        margin-top: 1.5rem;
      }

      .url-input {
        flex: 1;
        padding: 1rem 1.2rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        transition: all 0.3s;
      }

      .url-input:focus {
        outline: none;
        border-color: #ff3333;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.2);
      }

      .url-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      .confirm-btn {
        padding: 1rem 2rem;
        background: #ff3333;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .confirm-btn:hover {
        background: #cc0000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .confirm-btn.confirmed {
        background: #27ca3f;
      }

      .confirm-btn.confirmed:hover {
        background: #1fa832;
        box-shadow: 0 4px 8px rgba(39, 202, 63, 0.3);
      }

      /* Current Session Display - Updated CSS */
      .current-session-display {
        background: rgba(39, 202, 63, 0.1);
        border: 1px solid rgba(39, 202, 63, 0.3);
        border-radius: 12px;
        padding: 1.2rem 1.5rem;
        margin-bottom: 2rem;
        animation: fadeIn 0.5s ease;
      }

      .session-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .session-channel {
        font-size: 1.1rem;
        font-weight: 600;
        color: #27ca3f;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .session-channel:before {
        content: "‚ñ∂Ô∏è";
        font-size: 0.9rem;
      }

      .clear-session-btn {
        background: rgba(255, 51, 51, 0.2);
        color: #ff3333;
        border: 1px solid rgba(255, 51, 51, 0.3);
        border-radius: 4px;
        padding: 0.4rem 0.8rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
      }

      .clear-session-btn:hover {
        background: rgba(255, 51, 51, 0.3);
      }

      /* Status Message */
      .status-message {
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        display: none;
        margin-top: 1rem;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .status-success {
        background: rgba(39, 202, 63, 0.2);
        border: 1px solid #27ca3f;
        color: #27ca3f;
      }

      .status-error {
        background: rgba(255, 51, 51, 0.2);
        border: 1px solid #ff3333;
        color: #ff3333;
      }

      .status-info {
        background: rgba(66, 153, 225, 0.2);
        border: 1px solid #4299e1;
        color: #4299e1;
      }

      /* Loading Progress Bar */
      .loading-container {
        display: none;
        margin-top: 1.5rem;
        padding: 1rem 1.5rem;
        background: rgba(66, 153, 225, 0.1);
        border: 1px solid rgba(66, 153, 225, 0.3);
        border-radius: 12px;
        animation: fadeIn 0.3s ease;
      }

      .loading-header {
        margin-bottom: 0.8rem;
      }

      .loading-text {
        font-size: 0.95rem;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.8rem;
      }

      .progress-bar-wrapper {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .progress-bar-container {
        flex: 1;
        height: 18px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 9px;
        overflow: hidden;
        position: relative;
        border: 1px solid rgba(66, 153, 225, 0.3);
      }

      .loading-percentage {
        font-size: 1.1rem;
        font-weight: 700;
        color: #4299e1;
        min-width: 50px;
        text-align: right;
      }

      .progress-bar-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          #4299e1 0%,
          #9f7aea 50%,
          #f687b3 100%
        );
        border-radius: 9px;
        transition: width 0.5s ease;
        position: relative;
        overflow: hidden;
      }

      .progress-bar-fill::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(255, 255, 255, 0.3),
          transparent
        );
        animation: shimmer 2s infinite;
      }

      @keyframes shimmer {
        0% {
          transform: translateX(-100%);
        }
        100% {
          transform: translateX(100%);
        }
      }

      .loading-steps {
        margin-top: 1rem;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
        display: none;
      }

      /* Data Source Tabs */
      .data-source-tabs {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
        justify-content: center;
      }

      .tab-btn {
        padding: 0.8rem 1.5rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        color: white;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
      }

      .tab-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
      }

      .tab-btn.active {
        background: rgba(255, 51, 51, 0.2);
        border-color: #ff3333;
        color: #ff3333;
      }

      /* Analysis Section */
      .analysis-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .section-title {
        text-align: center;
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 2rem;
        color: white;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .analysis-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
      }

      .analysis-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.8rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        text-align: center;
      }

      .analysis-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-5px);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .analysis-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .analysis-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.8rem;
      }

      .analysis-desc {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
        margin-bottom: 1.5rem;
      }

      .analysis-link {
        display: inline-block;
        padding: 0.8rem 1.5rem;
        background: #ff3333;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        width: 100%;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .analysis-link:hover {
        background: #cc0000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .analysis-link.disabled {
        background: #666;
        cursor: not-allowed;
      }

      .analysis-link.disabled:hover {
        transform: none;
        background: #666;
        box-shadow: none;
      }

      /* Export PDF Button */
      .export-pdf-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 191, 255, 0.5) !important;
      }

      .export-pdf-btn:active {
        transform: translateY(0);
      }

      /* Progress Spinner */
      .progress-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Responsive Design - Matching Dashboard */
      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 220px 1fr;
        }

        .content {
          padding: 1.2rem 1.5rem;
        }

        .title {
          font-size: 1.6rem;
        }

        .brand {
          font-size: 1.7rem;
        }
      }

      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .sidebar {
          flex-direction: row;
          align-items: center;
          padding: 0.8rem 1rem;
          gap: 1rem;
        }

        .brand-section {
          margin-bottom: 0;
          padding: 0.3rem 0.5rem;
        }

        .brand {
          font-size: 1.7rem;
        }

        .create-btn {
          padding: 0.7rem 0.8rem;
          font-size: 0.9rem;
        }

        .menu {
          display: none;
        }

        .content {
          padding: 1rem 1.2rem;
        }

        .header {
          flex-direction: column;
          gap: 0.8rem;
          align-items: flex-start;
          margin-bottom: 1.2rem;
          padding-bottom: 0.8rem;
        }

        .title {
          font-size: 1.5rem;
          padding-top: 0;
        }

        .profile-btn {
          align-self: flex-start;
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
          margin-top: 0;
        }

        .analysis-grid {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 1.5rem;
        }

        .input-group {
          flex-direction: column;
        }

        .confirm-btn {
          width: 100%;
        }

        .data-source-tabs {
          flex-direction: column;
        }

        .tab-btn {
          width: 100%;
          text-align: center;
        }
      }

      @media (max-width: 480px) {
        .content {
          padding: 0.8rem 1rem;
        }

        .title {
          font-size: 1.4rem;
        }

        .profile-btn {
          padding: 0.5rem 1rem;
          font-size: 0.85rem;
        }

        .container {
          padding: 1.2rem;
        }

        .url-input-section,
        .analysis-section {
          padding: 1.5rem;
        }

        .session-info {
          flex-direction: column;
          gap: 0.5rem;
          align-items: flex-start;
        }

        .clear-session-btn {
          align-self: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <!-- Add project data element for storing project ID -->
    <div
      id="projectData"
      data-project-id="{{ project_id if project_id else 1 }}"
      style="display: none"
    ></div>

    <div class="layout">
      <aside class="sidebar">
        <div class="brand-section">
          <div class="brand">OrbitLink</div>
        </div>
        <a
          href="{{ url_for('projects.projects_create_get') }}"
          class="create-btn"
          >Create +</a
        >
        <nav class="menu">
          <a href="{{ url_for('projects.dashboard') }}">Dashboard</a>
          <a href="{{ url_for('review.review_page') }}?from=sna">Rate Us</a>
          <a
            href="{{ url_for('contact_support.contact_support_page') }}?from=sna"
            >Contact Support</a
          >
        </nav>
      </aside>

      <main class="content">
        <!-- Header - Now properly aligned with OrbitLink logo -->
        <div class="header">
          <div class="title">Project Analysis</div>
          <!-- <a href="{{ url_for('user.profile') }}" class="profile-btn">Profile</a> -->
          <!-- <a href="{{ url_for('projects.dashboard') }}"class="profile-btn">Home</a> -->
        </div>

        <div class="container">
          <!-- Data Input Section -->
          <div class="url-input-section">
            <div class="input-header">
              <h3 id="currentAnalysisTitle">Enter Data Source</h3>
              <p id="currentAnalysisDesc">
                Paste the URL of a YouTube channel or video you want to analyze
              </p>
            </div>

            <!-- Current Session Display - Simplified Version -->
            <div
              id="currentSession"
              class="current-session-display"
              style="display: none"
            >
              <div class="session-info">
                <span class="session-channel" id="sessionChannel"></span>
                <button class="clear-session-btn" id="clearSessionBtn">
                  √ó Clear
                </button>
              </div>
              <!-- Video Link Display -->
              <div id="videoLinkDisplay" class="video-link-display" style="display: none; margin-top: 1rem; padding: 0.8rem; background: rgba(242, 72, 34, 0.1); border-radius: 8px; border-left: 3px solid #f24822;">
                <a id="videoLink" href="#" target="_blank" rel="noopener noreferrer" style="display: inline-flex; align-items: center; gap: 0.5rem; color: #f24822; text-decoration: none; font-weight: 600; font-size: 0.9rem;">
                  <span>üé¨</span> <span id="videoLinkText">Watch analyzed video on YouTube</span>
                </a>
              </div>
              <!-- REMOVED: session-actions div -->
            </div>

            <!-- URL Input (hidden when session exists) -->
            <div id="urlInputSection">
              <div class="input-group">
                <input
                  type="url"
                  id="youtubeUrl"
                  class="url-input"
                  placeholder="https://www.youtube.com/@ChannelName or https://www.youtube.com/watch?v=..."
                  value=""
                />
                <button type="button" class="confirm-btn" id="confirmBtn">
                  Analyze
                </button>
              </div>
            </div>

            <div id="statusMessage" class="status-message"></div>

            <!-- Loading Progress Bar -->
            <div id="loadingContainer" class="loading-container">
              <div class="loading-header">
                <div class="loading-text" id="loadingText">Getting data...</div>
              </div>
              <div class="progress-bar-wrapper">
                <div class="progress-bar-container">
                  <div
                    class="progress-bar-fill"
                    id="progressBarFill"
                    style="width: 0%"
                  ></div>
                </div>
                <div class="loading-percentage" id="loadingPercentage">0%</div>
              </div>
              <div class="loading-steps" id="loadingSteps">Preparing...</div>
            </div>
          </div>

          <!-- Analysis Options Section -->
          <div class="analysis-section">
            <h2 class="section-title">Select Analysis Type</h2>
            <div class="analysis-grid">
              <!-- Sentiment Analysis Card -->
              <div class="analysis-card disabled" id="sentimentCard">
                <h3 class="analysis-name">Sentiment Analysis</h3>
                <p class="analysis-desc">
                  Analyze opinions and track sentiment shifts over time to
                  understand public perception
                </p>
                <a
                  href="{{ url_for('projects.sentiment_analysis') }}"
                  class="analysis-link disabled"
                  id="sentimentLink"
                  onclick="return addProjectIdToLink(this);"
                  >Open Analysis</a
                >
              </div>

              <!-- Influencer Detection Card -->
              <div class="analysis-card disabled" id="influencersCard">
                <h3 class="analysis-name">Identify Influencers</h3>
                <p class="analysis-desc">
                  Identify key influencers and high-impact accounts driving
                  conversations
                </p>
                <a
                  href="{{ url_for('projects.identify_influencers') }}"
                  class="analysis-link disabled"
                  id="influencersLink"
                  onclick="return addProjectIdToLink(this);"
                  >Open Analysis</a
                >
              </div>

              <!-- Community Detection Card -->
              <div class="analysis-card disabled" id="communitiesCard">
                <h3 class="analysis-name">Detect Communities</h3>
                <p class="analysis-desc">
                  Detect subgroups and analyze information flows between
                  different community segments
                </p>
                <a
                  href="{{ url_for('projects.detect_communities') }}"
                  class="analysis-link disabled"
                  id="communitiesLink"
                  onclick="return addProjectIdToLink(this);"
                  >Open Analysis</a
                >
              </div>

              <!-- Predictive Analysis Card -->
              <div class="analysis-card disabled" id="predictiveCard">
                <h3 class="analysis-name">Predictive Analysis</h3>
                <p class="analysis-desc">
                  Forecast trends and predict future engagement patterns using
                  machine learning models
                </p>
                <a
                  href="{{ url_for('projects.predictive_analysis') }}"
                  class="analysis-link disabled"
                  id="predictiveLink"
                  onclick="return addProjectIdToLink(this);"
                  >Open Analysis</a
                >
              </div>
            </div>

            <!-- Export PDF Button Section -->
            <div
              id="exportSection"
              style="display: none; margin-top: 2rem; text-align: center"
            >
              <button
                onclick="exportAnalysisPDF()"
                class="export-pdf-btn"
                style="
                  background: linear-gradient(135deg, #00bfff, #0080ff);
                  color: white;
                  border: none;
                  padding: 0.9rem 2rem;
                  border-radius: 10px;
                  font-weight: 700;
                  font-size: 1rem;
                  cursor: pointer;
                  transition: all 0.3s;
                  box-shadow: 0 4px 12px rgba(0, 191, 255, 0.3);
                "
              >
                üìÑ Export All Analyses as PDF
              </button>
              <p style="color: #b0c4de; font-size: 0.85rem; margin-top: 0.5rem">
                Download a comprehensive report including all 4 analyses
              </p>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      // Function to handle YouTube analysis - UPDATED FOR BOTH VIDEO AND CHANNEL
      async function analyzeYouTubeChannel() {
        const urlInput = document.getElementById("youtubeUrl");
        const youtubeUrl = urlInput.value.trim();
        const confirmBtn = document.getElementById("confirmBtn");
        const statusMessage = document.getElementById("statusMessage");
        const projectId = getCurrentProjectId();

        if (!youtubeUrl) {
          showStatus("Please enter a YouTube channel or video URL", "error");
          return;
        }

        // Check if it's a valid YouTube URL
        const youtubePattern = /(youtube\.com|youtu\.be)/;
        if (!youtubePattern.test(youtubeUrl)) {
          showStatus("Please enter a valid YouTube URL", "error");
          return;
        }

        // Show loading bar instead of status message
        confirmBtn.textContent = "Analyzing...";
        confirmBtn.disabled = true;
        statusMessage.style.display = "none";
        showLoadingProgress();

        try {
          const response = await fetch("/projects/analyze-youtube", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              youtube_url: youtubeUrl,
              project_id: projectId,
            }),
          });

          const result = await response.json();

          if (result.success) {
            const analysisType = result.data.analysis_type || "channel";
            const analysisTitle =
              analysisType === "video"
                ? result.data.video_metadata.title
                : result.data.channel_metadata.title;

            // Complete the progress bar
            completeLoadingProgress();

            setTimeout(() => {
              hideLoadingProgress();
              showStatus(
                `‚úì Analysis completed! Analyzed ${result.data.total_comments.toLocaleString()} comments.`,
                "success",
              );
            }, 800);

            // Store analysis results WITH PROJECT ID
            const storageKey = `youtubeAnalysis_${projectId}`;
            sessionStorage.setItem(storageKey, JSON.stringify(result.data));
            console.log(`[STORAGE] Saved analysis to ${storageKey}`);
            console.log(`[STORAGE] Analysis type: ${result.data.analysis_type}`);
            console.log(`[STORAGE] Data structure:`, result.data);
            
            // Verify storage
            const stored = sessionStorage.getItem(storageKey);
            console.log(`[STORAGE] Verification - Data stored successfully:`, stored !== null);

            // Enable all analysis cards
            enableAnalysisCards(projectId);

            // Show current session
            await loadCurrentSession(projectId);

            // Update button state
            confirmBtn.textContent = "Analyzed ‚úì";
            confirmBtn.classList.add("confirmed");
          } else {
            showStatus(`‚ùå Analysis failed: ${result.error}`, "error");
            confirmBtn.textContent = "Try Again";
            confirmBtn.disabled = false;
          }
        } catch (error) {
          console.error("Analysis error:", error);
          hideLoadingProgress();
          showStatus(
            "‚ùå Connection error. Please check your internet and try again.",
            "error",
          );
          confirmBtn.textContent = "Try Again";
          confirmBtn.disabled = false;
        }
      }

      // Loading progress animation
      let progressInterval = null;
      let currentProgress = 0;

      function showLoadingProgress() {
        const loadingContainer = document.getElementById("loadingContainer");
        const progressBarFill = document.getElementById("progressBarFill");
        const loadingPercentage = document.getElementById("loadingPercentage");
        const loadingText = document.getElementById("loadingText");
        const loadingSteps = document.getElementById("loadingSteps");

        loadingContainer.style.display = "block";
        currentProgress = 0;

        const steps = [
          { percent: 10, text: "Getting info..." },
          { percent: 20, text: "Validating input..." },
          { percent: 30, text: "Loading resources..." },
          { percent: 40, text: "Building structure..." },
          { percent: 50, text: "Analyzing content..." },
          { percent: 60, text: "Generating insights..." },
          { percent: 70, text: "Organizing data..." },
          { percent: 80, text: "Optimizing results..." },
          { percent: 90, text: "Preparing output..." },
          { percent: 95, text: "Almost done..." },
        ];

        let stepIndex = 0;

        progressInterval = setInterval(() => {
          if (currentProgress < 92) {
            if (
              stepIndex < steps.length &&
              currentProgress >= steps[stepIndex].percent
            ) {
              loadingText.textContent = steps[stepIndex].text;
              stepIndex++;
            }

            currentProgress += Math.random() * 3;
            if (currentProgress > 92) currentProgress = 92;

            progressBarFill.style.width = currentProgress + "%";
            loadingPercentage.textContent = Math.floor(currentProgress) + "%";
          }
        }, 400);
      }

      function completeLoadingProgress() {
        if (progressInterval) {
          clearInterval(progressInterval);
        }

        const progressBarFill = document.getElementById("progressBarFill");
        const loadingPercentage = document.getElementById("loadingPercentage");
        const loadingText = document.getElementById("loadingText");
        const loadingSteps = document.getElementById("loadingSteps");

        currentProgress = 100;
        progressBarFill.style.width = "100%";
        loadingPercentage.textContent = "100%";
        loadingText.textContent = "‚úì Complete!";
      }

      function hideLoadingProgress() {
        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }

        const loadingContainer = document.getElementById("loadingContainer");
        loadingContainer.style.display = "none";
        currentProgress = 0;
      }

      // Load current session from server - PROJECT-SPECIFIC
      async function loadCurrentSession(projectId) {
        try {
          const currentProjectId = projectId || getCurrentProjectId();
          const response = await fetch(
            `/projects/${currentProjectId}/current-session`,
          );
          const session = await response.json();

          if (session && session.channel_title) {
            showCurrentSession(session, currentProjectId);
            return true;
          }
          return false;
        } catch (error) {
          console.error("Error loading session:", error);
          return false;
        }
      }

      function showCurrentSession(session, projectId) {
        const sessionDisplay = document.getElementById("currentSession");
        const urlInputSection = document.getElementById("urlInputSection");
        const title = document.getElementById("currentAnalysisTitle");
        const desc = document.getElementById("currentAnalysisDesc");

        // Check if this is a video or channel analysis
        const analysisData = session.analysis_data || {};
        const analysisType = analysisData.analysis_type || "channel";
        const displayName =
          analysisType === "video"
            ? `Video: ${analysisData.video_metadata?.title || session.channel_title}`
            : `Channel: ${session.channel_title}`;

        document.getElementById("sessionChannel").textContent =
          `Currently analyzing: ${displayName}`;

        // Show video link if it's a video analysis
        const videoLinkDisplay = document.getElementById("videoLinkDisplay");
        const videoLink = document.getElementById("videoLink");
        const videoLinkText = document.getElementById("videoLinkText");
        
        if (analysisType === "video" && analysisData.video_metadata?.video_id) {
          const videoId = analysisData.video_metadata.video_id;
          const videoTitle = analysisData.video_metadata.title || "Video";
          videoLink.href = `https://www.youtube.com/watch?v=${videoId}`;
          videoLinkText.textContent = `Watch "${videoTitle}" on YouTube`;
          videoLinkDisplay.style.display = "block";
        } else {
          videoLinkDisplay.style.display = "none";
        }

        sessionDisplay.style.display = "block";
        urlInputSection.style.display = "none";

        title.textContent = "Analysis Ready!";
        desc.textContent = `You're analyzing "${displayName}". Select an analysis type below.`;

        // Enable all analysis cards
        enableAnalysisCards(projectId);

        // Store project ID for analysis pages
        localStorage.setItem("currentProjectId", projectId);

        // Also store in session storage for immediate access
        const youtubeAnalysis = sessionStorage.getItem(
          `youtubeAnalysis_${projectId}`,
        );
        if (!youtubeAnalysis && session.analysis_data) {
          sessionStorage.setItem(
            `youtubeAnalysis_${projectId}`,
            JSON.stringify(session.analysis_data),
          );
        }
      }

      // Function to show stored analysis session
      function showStoredAnalysisSession(projectId, data) {
        const sessionDisplay = document.getElementById("currentSession");
        const urlInputSection = document.getElementById("urlInputSection");
        const title = document.getElementById("currentAnalysisTitle");
        const desc = document.getElementById("currentAnalysisDesc");

        if (sessionDisplay) {
          const analysisType = data.analysis_type || "channel";
          const displayName =
            analysisType === "video"
              ? `Video: ${data.video_metadata?.title || "Unknown Video"}`
              : `Channel: ${data.channel_metadata?.title || "Unknown Channel"}`;

          document.getElementById("sessionChannel").textContent =
            `Currently analyzing: ${displayName}`;

          // Show video link if it's a video analysis
          const videoLinkDisplay = document.getElementById("videoLinkDisplay");
          const videoLink = document.getElementById("videoLink");
          const videoLinkText = document.getElementById("videoLinkText");
          
          if (analysisType === "video" && data.video_metadata?.video_id) {
            const videoId = data.video_metadata.video_id;
            const videoTitle = data.video_metadata.title || "Video";
            videoLink.href = `https://www.youtube.com/watch?v=${videoId}`;
            videoLinkText.textContent = `Watch "${videoTitle}" on YouTube`;
            videoLinkDisplay.style.display = "block";
          } else {
            videoLinkDisplay.style.display = "none";
          }

          sessionDisplay.style.display = "block";
          urlInputSection.style.display = "none";

          title.textContent = "Analysis Ready!";
          desc.textContent = `You're analyzing "${displayName}". Select an analysis type below.`;

          // Enable all analysis cards
          enableAnalysisCards(projectId);

          const confirmBtn = document.getElementById("confirmBtn");
          if (confirmBtn) {
            confirmBtn.textContent = "Analyzed ‚úì";
            confirmBtn.classList.add("confirmed");
          }
        }
      }

      async function clearCurrentSession() {
        if (
          !confirm(
            "Clear current analysis session? You'll need to re-analyze to view results.",
          )
        ) {
          return;
        }

        const projectId = getCurrentProjectId();

        // Clear frontend storage
        sessionStorage.removeItem(`youtubeAnalysis_${projectId}`);
        sessionStorage.removeItem("youtubeAnalysis");

        // Reset UI
        const sessionDisplay = document.getElementById("currentSession");
        const urlInputSection = document.getElementById("urlInputSection");
        const title = document.getElementById("currentAnalysisTitle");
        const desc = document.getElementById("currentAnalysisDesc");
        const confirmBtn = document.getElementById("confirmBtn");
        const urlInput = document.getElementById("youtubeUrl");
        const videoLinkDisplay = document.getElementById("videoLinkDisplay");

        sessionDisplay.style.display = "none";
        urlInputSection.style.display = "block";
        if (videoLinkDisplay) {
          videoLinkDisplay.style.display = "none";
        }

        title.textContent = "Enter Data Source";
        desc.textContent =
          "Paste the URL of a YouTube channel or video you want to analyze";

        if (confirmBtn) {
          confirmBtn.textContent = "Analyze";
          confirmBtn.classList.remove("confirmed");
          confirmBtn.disabled = false;
        }

        if (urlInput) {
          urlInput.value = "";
        }

        // Disable all analysis cards
        document.querySelectorAll(".analysis-card").forEach((card) => {
          card.classList.add("disabled");
        });

        document.querySelectorAll(".analysis-link").forEach((link) => {
          link.classList.add("disabled");
        });

        showStatus(
          "‚úì Session cleared. Enter a new channel or video URL to analyze.",
          "success",
        );
      }

      // Helper function to append project ID to links - PROJECT-SPECIFIC
      function addProjectIdToLink(linkElement, projectId) {
        // If card is disabled, prevent navigation
        if (linkElement.classList.contains("disabled")) {
          showStatus(
            "Please analyze a YouTube channel or video first",
            "error",
          );
          return false;
        }

        const currentProjectId = projectId || getCurrentProjectId();
        console.log(
          `[addProjectIdToLink] Element: ${linkElement.id}, Project ID: ${currentProjectId}`,
        );

        if (currentProjectId) {
          const currentHref = linkElement.getAttribute("href");
          const separator = currentHref.includes("?") ? "&" : "?";
          const newHref = `${currentHref}${separator}project_id=${currentProjectId}`;
          linkElement.setAttribute("href", newHref);
          console.log(`[addProjectIdToLink] Updated href to: ${newHref}`);

          // Store in localStorage for the analysis page to use
          localStorage.setItem("currentProjectId", currentProjectId);

          // Also store in sessionStorage for immediate access
          const analysisData = sessionStorage.getItem(
            `youtubeAnalysis_${currentProjectId}`,
          );
          if (analysisData) {
            sessionStorage.setItem("youtubeAnalysis", analysisData);
          }
        }
        return true;
      }

      // Function to enable analysis cards - Check for PROJECT-SPECIFIC data
      function enableAnalysisCards(projectId) {
        const currentProjectId = projectId || getCurrentProjectId();
        const hasAnalysisData =
          sessionStorage.getItem(`youtubeAnalysis_${currentProjectId}`) !==
          null;

        if (hasAnalysisData) {
          const analysisCards = document.querySelectorAll(".analysis-card");
          const analysisLinks = document.querySelectorAll(".analysis-link");

          analysisCards.forEach((card) => {
            card.classList.remove("disabled");
          });

          analysisLinks.forEach((link) => {
            link.classList.remove("disabled");
            // Add click handler to append project ID
            link.onclick = function (e) {
              return addProjectIdToLink(this, currentProjectId);
            };
          });

          // Show export PDF button
          const exportSection = document.getElementById("exportSection");
          if (exportSection) {
            exportSection.style.display = "block";
          }
        }
      }

      function exportAnalysisPDF() {
        const projectId = getCurrentProjectId();

        if (!projectId) {
          showStatus(
            "‚ùå No project selected. Please select a project first.",
            "error",
          );
          return;
        }

        // Check if analysis data exists
        const hasAnalysisData =
          sessionStorage.getItem(`youtubeAnalysis_${projectId}`) !== null;

        if (!hasAnalysisData) {
          showStatus(
            "‚ùå No analysis data available. Please run an analysis first.",
            "error",
          );
          return;
        }

        showStatus("üìÑ Generating PDF report...", "info");

        // Trigger PDF download
        window.location.href = `/projects/${projectId}/export-pdf`;

        setTimeout(() => {
          showStatus("‚úÖ PDF report generated successfully!", "success");
        }, 2000);
      }

      // Helper function to get project ID from URL or data element
      function getCurrentProjectId() {
        // First try to get from URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get("project_id");

        if (urlProjectId) {
          // Store in the data element for consistency
          const projectData = document.getElementById("projectData");
          if (projectData) {
            projectData.dataset.projectId = urlProjectId;
          }
          return urlProjectId;
        }

        // Then try from data element
        const projectData = document.getElementById("projectData");
        return projectData ? projectData.dataset.projectId : null;
      }

      // UPDATED: Simple YouTube URL validation for both channel and video URLs
      function isValidYouTubeUrl(url) {
        const youtubePattern = /(youtube\.com|youtu\.be)/;
        return youtubePattern.test(url);
      }

      function showStatus(message, type) {
        const statusMessage = document.getElementById("statusMessage");
        statusMessage.textContent = message;
        statusMessage.className = "status-message";
        statusMessage.classList.add(`status-${type}`);
        statusMessage.style.display = "block";

        // Auto-hide success messages after 8 seconds
        if (type === "success") {
          setTimeout(() => {
            if (statusMessage.textContent.includes("‚úì Analysis completed!")) {
              // Don't hide if we're showing success message with data
              return;
            }
            statusMessage.style.display = "none";
          }, 8000);
        }
      }

      function showComingSoon() {
        showStatus(
          "üöß Predictive Analysis is coming soon! This feature is currently under development.",
          "info",
        );
      }

      document.addEventListener("DOMContentLoaded", function () {
        const urlInput = document.getElementById("youtubeUrl");
        const confirmBtn = document.getElementById("confirmBtn");
        const analysisLinks = document.querySelectorAll(".analysis-link");
        const analysisCards = document.querySelectorAll(".analysis-card");
        const clearSessionBtn = document.getElementById("clearSessionBtn");

        // Get current project ID from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get("project_id");
        const storedProjectId = localStorage.getItem("currentProjectId");
        const currentProjectId =
          urlProjectId || storedProjectId || getCurrentProjectId();

        // Store project ID in both localStorage and the data element
        if (currentProjectId) {
          localStorage.setItem("currentProjectId", currentProjectId);
          const projectData = document.getElementById("projectData");
          if (projectData) {
            projectData.dataset.projectId = currentProjectId;
          }
        }

        console.log("Current Project ID:", currentProjectId);

        // Load current session for THIS PROJECT on page load
        if (currentProjectId) {
          loadCurrentSession(currentProjectId).then((success) => {
            if (success) {
              console.log("Session loaded successfully");
            } else {
              console.log("No session found for project");
              // Check if we have stored analysis data
              checkForStoredAnalysis(currentProjectId);
            }
          });
        }

        // Function to check for stored analysis data
        async function checkForStoredAnalysis(projectId) {
          try {
            const projectAnalysis = sessionStorage.getItem(
              `youtubeAnalysis_${projectId}`,
            );
            if (projectAnalysis) {
              const data = JSON.parse(projectAnalysis);
              if (data.total_comments) {
                // We have analysis data, show session and enable cards
                showStoredAnalysisSession(projectId, data);
              }
            }
          } catch (e) {
            console.error("Error checking stored analysis:", e);
          }
        }

        // Add event listener for clear session button
        if (clearSessionBtn) {
          clearSessionBtn.addEventListener("click", clearCurrentSession);
        }

        // Add event listener for confirm button - now using analyzeYouTubeChannel
        confirmBtn.addEventListener("click", function () {
          analyzeYouTubeChannel();
        });

        // Clear status when user starts typing
        urlInput.addEventListener("input", function () {
          const statusMessage = document.getElementById("statusMessage");
          statusMessage.style.display = "none";
          confirmBtn.textContent = "Analyze";
          confirmBtn.classList.remove("confirmed");
          confirmBtn.disabled = false;
        });

        // Keyboard shortcut: Enter to confirm
        urlInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            confirmBtn.click();
          }
        });

        // Initialize with YouTube placeholder
        updlysisCards.forEach((card) => {
          card.addEventListener("click", function (e) {
            // Only trigger if not disabled and not clicking on the link itself
            if (
              !this.classList.contains("disabled") &&
              e.target !== this.querySelector(".analysis-link")
            ) {
              const link = this.querySelector(".analysis-link");
              if (link && !link.classList.contains("disabled")) {
                // Add visual feedback before navigation
                this.style.transform = "scale(0.98)";
                setTimeout(() => {
                  this.style.transform = "";
                }, 200);
              }
            }
          });
        });
      });
    </script>
  </body>
</html>
