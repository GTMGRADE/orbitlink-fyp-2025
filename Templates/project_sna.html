<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project SNA - OrbitLink</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #1E3167; /* Same blue as dashboard/landing */
        color: white;
        min-height: 100vh;
      }

      /* Unified Layout - Matching Dashboard */
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: 100vh;
      }

      /* Sidebar - More Compact (Matching Dashboard) */
      .sidebar {
        background: #F24822; /* Same orange */
        padding: 1.2rem 0.8rem;
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        position: relative;
      }

      /* Brand - More Compact, Aligned with Dashboard */
      .brand-section {
        display: flex;
        align-items: center;
        padding: 0.5rem 0.8rem;
        margin-bottom: 0.2rem;
      }

      .brand {
        font-size: 1.9rem;
        font-weight: bold;
        color: black;
        line-height: 1;
      }

      /* Create Button - More Compact (Matching Dashboard) */
      .create-btn {
        background: #14294a;
        color: white;
        border-radius: 10px;
        padding: 0.9rem 0.8rem;
        text-align: center;
        font-weight: 700;
        font-size: 1rem;
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .create-btn:hover {
        background: #0f1c3d;
        transform: translateY(-1px);
      }

      /* Menu - Moved Higher (Matching Dashboard) */
      .menu {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.3rem;
      }

      .menu a {
        display: block;
        padding: 0.75rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
      }

      .menu a.active {
        background: rgba(255, 255, 255, 0.22);
        border-color: rgba(255, 255, 255, 0.15);
      }

      .menu a:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateX(3px);
      }

      /* Main Content Area - Matching Dashboard Blue */
      .content {
        background: #1E3167;
        padding: 1.5rem 2rem;
      }

      /* Header - More Compact, Better Alignment (Matching Dashboard) */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.2rem;
        padding-bottom: 0.8rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }

      .title {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        letter-spacing: 0.3px;
        line-height: 1;
        padding-top: 0.2rem;
      }

      .profile-btn {
        text-decoration: none;
        color: black;
        font-weight: 700;
        padding: 0.7rem 1.5rem;
        background: #ff3333;
        border-radius: 6px;
        transition: all 0.2s;
        font-size: 0.95rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        line-height: 1;
        height: fit-content;
        margin-top: 0.2rem;
      }

      .profile-btn:hover {
        background: #cc0000;
        color: white;
        transform: translateY(-2px);
      }

      .profile-btn:active {
        transform: translateY(0);
      }

      /* Main Container - Matching Dashboard Style */
      .container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-width: 1200px;
        margin: 0 auto;
      }
      
      /* URL Input Section - Cleaner Design */
      .url-input-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .input-header {
        text-align: center;
        margin-bottom: 1.5rem;
      }
      
      .input-header h3 {
        font-size: 1.4rem;
        color: white;
        margin-bottom: 0.8rem;
        font-weight: 700;
      }
      
      .input-header p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 1rem;
        line-height: 1.5;
        max-width: 600px;
        margin: 0 auto;
      }
      
      .input-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        margin-top: 1.5rem;
      }
      
      .url-input {
        flex: 1;
        padding: 1rem 1.2rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
        transition: all 0.3s;
      }
      
      .url-input:focus {
        outline: none;
        border-color: #ff3333;
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 2px rgba(255, 51, 51, 0.2);
      }
      
      .url-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }
      
      .confirm-btn {
        padding: 1rem 2rem;
        background: #ff3333;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .confirm-btn:hover {
        background: #cc0000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      
      .confirm-btn.confirmed {
        background: #27ca3f;
      }
      
      .confirm-btn.confirmed:hover {
        background: #1fa832;
        box-shadow: 0 4px 8px rgba(39, 202, 63, 0.3);
      }
      
      /* Current Session Display - Updated CSS */
      .current-session-display {
        background: rgba(39, 202, 63, 0.1);
        border: 1px solid rgba(39, 202, 63, 0.3);
        border-radius: 12px;
        padding: 1.2rem 1.5rem;
        margin-bottom: 2rem;
        animation: fadeIn 0.5s ease;
      }

      .session-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .session-channel {
        font-size: 1.1rem;
        font-weight: 600;
        color: #27ca3f;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .session-channel:before {
        content: "▶️";
        font-size: 0.9rem;
      }

      .clear-session-btn {
        background: rgba(255, 51, 51, 0.2);
        color: #ff3333;
        border: 1px solid rgba(255, 51, 51, 0.3);
        border-radius: 4px;
        padding: 0.4rem 0.8rem;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
      }

      .clear-session-btn:hover {
        background: rgba(255, 51, 51, 0.3);
      }
      
      /* Status Message */
      .status-message {
        padding: 1rem;
        border-radius: 8px;
        text-align: center;
        font-weight: 600;
        display: none;
        margin-top: 1rem;
        animation: fadeIn 0.3s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .status-success {
        background: rgba(39, 202, 63, 0.2);
        border: 1px solid #27ca3f;
        color: #27ca3f;
      }
      
      .status-error {
        background: rgba(255, 51, 51, 0.2);
        border: 1px solid #ff3333;
        color: #ff3333;
      }
      
      .status-info {
        background: rgba(66, 153, 225, 0.2);
        border: 1px solid #4299e1;
        color: #4299e1;
      }
      
      /* Data Source Tabs */
      .data-source-tabs {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
        justify-content: center;
      }
      
      .tab-btn {
        padding: 0.8rem 1.5rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 20px;
        color: white;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s;
      }
      
      .tab-btn:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
      }
      
      .tab-btn.active {
        background: rgba(255, 51, 51, 0.2);
        border-color: #ff3333;
        color: #ff3333;
      }
      
      /* Analysis Section */
      .analysis-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .section-title {
        text-align: center;
        font-size: 1.4rem;
        font-weight: 700;
        margin-bottom: 2rem;
        color: white;
        padding-bottom: 1rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }
      
      .analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
      }
      
      .analysis-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 1.8rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        text-align: center;
      }
      
      .analysis-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-5px);
        border-color: rgba(255, 255, 255, 0.2);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      
      .analysis-card.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }
      
      .analysis-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.8rem;
      }
      
      .analysis-desc {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        line-height: 1.5;
        margin-bottom: 1.5rem;
      }
      
      .analysis-link {
        display: inline-block;
        padding: 0.8rem 1.5rem;
        background: #ff3333;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        width: 100%;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .analysis-link:hover {
        background: #cc0000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      
      .analysis-link.disabled {
        background: #666;
        cursor: not-allowed;
      }
      
      .analysis-link.disabled:hover {
        transform: none;
        background: #666;
        box-shadow: none;
      }
      
      /* Progress Spinner */
      .progress-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* Responsive Design - Matching Dashboard */
      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 220px 1fr;
        }
        
        .content {
          padding: 1.2rem 1.5rem;
        }
        
        .title {
          font-size: 1.6rem;
        }
        
        .brand {
          font-size: 1.7rem;
        }
      }

      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
        }

        .sidebar {
          flex-direction: row;
          align-items: center;
          padding: 0.8rem 1rem;
          gap: 1rem;
        }

        .brand-section {
          margin-bottom: 0;
          padding: 0.3rem 0.5rem;
        }

        .brand {
          font-size: 1.7rem;
        }

        .create-btn {
          padding: 0.7rem 0.8rem;
          font-size: 0.9rem;
        }

        .menu {
          display: none;
        }

        .content {
          padding: 1rem 1.2rem;
        }

        .header {
          flex-direction: column;
          gap: 0.8rem;
          align-items: flex-start;
          margin-bottom: 1.2rem;
          padding-bottom: 0.8rem;
        }

        .title {
          font-size: 1.5rem;
          padding-top: 0;
        }

        .profile-btn {
          align-self: flex-start;
          padding: 0.6rem 1.2rem;
          font-size: 0.9rem;
          margin-top: 0;
        }

        .analysis-grid {
          grid-template-columns: 1fr;
        }

        .container {
          padding: 1.5rem;
        }

        .input-group {
          flex-direction: column;
        }

        .confirm-btn {
          width: 100%;
        }

        .data-source-tabs {
          flex-direction: column;
        }

        .tab-btn {
          width: 100%;
          text-align: center;
        }
      }

      @media (max-width: 480px) {
        .content {
          padding: 0.8rem 1rem;
        }

        .title {
          font-size: 1.4rem;
        }

        .profile-btn {
          padding: 0.5rem 1rem;
          font-size: 0.85rem;
        }
        
        .container {
          padding: 1.2rem;
        }
        
        .url-input-section,
        .analysis-section {
          padding: 1.5rem;
        }
        
        .session-info {
          flex-direction: column;
          gap: 0.5rem;
          align-items: flex-start;
        }
        
        .clear-session-btn {
          align-self: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <!-- Add project data element for storing project ID -->
    <div id="projectData" data-project-id="{{ project_id if project_id else 1 }}" style="display: none;"></div>
    
    <div class="layout">
      <aside class="sidebar">
        <div class="brand-section">
          <div class="brand">OrbitLink</div>
        </div>
        <a href="{{ url_for('projects.projects_create_get') }}" class="create-btn">Create +</a>
        <nav class="menu">
          <a href="{{ url_for('projects.dashboard') }}">Dashboard</a>
          <a href="{{ url_for('projects.projects_list') }}">Projects</a>
          <a href="{{ url_for('projects.project_sna') }}" class="active">Analysis</a>
          <a href="#">Support</a>
          <a href="#">Setting</a>
        </nav>
      </aside>

      <main class="content">
        <!-- Header - Now properly aligned with OrbitLink logo -->
        <div class="header">
          <div class="title">Project Analysis</div>
          <a href="{{ url_for('user.profile') }}" class="profile-btn">Profile</a>
        </div>

        <div class="container">
          <!-- Data Input Section -->
          <div class="url-input-section">
            <div class="input-header">
              <h3 id="currentAnalysisTitle">Enter Data Source</h3>
              <p id="currentAnalysisDesc">Paste the URL of the YouTube channel you want to analyze</p>
            </div>
            
            <!-- Current Session Display - Simplified Version -->
            <div id="currentSession" class="current-session-display" style="display: none;">
              <div class="session-info">
                <span class="session-channel" id="sessionChannel"></span>
                <button class="clear-session-btn" id="clearSessionBtn">× Clear</button>
              </div>
              <!-- REMOVED: session-actions div -->
            </div>
            
            <!-- URL Input (hidden when session exists) -->
            <div id="urlInputSection">
              <div class="input-group">
                <input 
                  type="url" 
                  id="youtubeUrl" 
                  class="url-input" 
                  placeholder="https://www.youtube.com/@ChannelName or https://www.youtube.com/c/ChannelName"
                  value=""
                />
                <button type="button" class="confirm-btn" id="confirmBtn">Analyze</button>
              </div>
              
              <!-- Data source tabs -->
              <div class="data-source-tabs">
                <button class="tab-btn active" data-source="youtube">YouTube</button>
                <button class="tab-btn" data-source="csv">CSV Upload</button>
              </div>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
          </div>

          <!-- Analysis Options Section -->
          <div class="analysis-section">
            <h2 class="section-title">Select Analysis Type</h2>
            <div class="analysis-grid">
              <!-- Sentiment Analysis Card -->
              <div class="analysis-card disabled" id="sentimentCard">
                <h3 class="analysis-name">Sentiment Analysis</h3>
                <p class="analysis-desc">Analyze opinions and track sentiment shifts over time to understand public perception</p>
                <a href="{{ url_for('projects.sentiment_analysis') }}" 
                   class="analysis-link disabled" 
                   id="sentimentLink"
                   onclick="return addProjectIdToLink(this)">Open Analysis</a>
              </div>

              <!-- Data Monitoring Card -->
              <div class="analysis-card disabled" id="monitoringCard">
                <h3 class="analysis-name">Data Monitoring</h3>
                <p class="analysis-desc">Track follower dynamics, post performance, and engagement metrics in real-time</p>
                <a href="{{ url_for('projects.data_monitoring') }}" 
                   class="analysis-link disabled" 
                   id="monitoringLink"
                   onclick="return addProjectIdToLink(this)">Open Analysis</a>
              </div>

              <!-- Historical Analysis Card -->
              <div class="analysis-card disabled" id="historicalCard">
                <h3 class="analysis-name">Historical Analysis</h3>
                <p class="analysis-desc">Analyze long-term trends, follower growth, and historical campaign performance</p>
                <a href="{{ url_for('projects.historical_analysis') }}" 
                   class="analysis-link disabled" 
                   id="historicalLink"
                   onclick="return addProjectIdToLink(this)">Open Analysis</a>
              </div>

              {% if session.get('user_type') == 'business' %}
              <!-- Influencer Detection Card -->
              <div class="analysis-card disabled" id="influencersCard">
                <h3 class="analysis-name">Identify Influencers</h3>
                <p class="analysis-desc">Identify key influencers and high-impact accounts driving conversations</p>
                <a href="{{ url_for('projects.identify_influencers') }}" 
                   class="analysis-link disabled" 
                   id="influencersLink"
                   onclick="return addProjectIdToLink(this)">Open Analysis</a>
              </div>

              <!-- Community Detection Card -->
              <div class="analysis-card disabled" id="communitiesCard">
                <h3 class="analysis-name">Detect Communities</h3>
                <p class="analysis-desc">Detect subgroups and analyze information flows between different community segments</p>
                <a href="{{ url_for('projects.detect_communities') }}" 
                   class="analysis-link disabled" 
                   id="communitiesLink"
                   onclick="return addProjectIdToLink(this)">Open Analysis</a>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </main>
    </div>

    <script>
      // Function to handle YouTube analysis
      async function analyzeYouTubeChannel() {
        const urlInput = document.getElementById('youtubeUrl');
        const channelUrl = urlInput.value.trim();
        const confirmBtn = document.getElementById('confirmBtn');
        const statusMessage = document.getElementById('statusMessage');
        
        if (!channelUrl) {
          showStatus('Please enter a YouTube channel URL', 'error');
          return;
        }
        
        // Validate YouTube URL
        if (!isValidYouTubeUrl(channelUrl)) {
          showStatus('Please enter a valid YouTube channel URL (e.g., https://www.youtube.com/@ChannelName)', 'error');
          return;
        }
        
        const projectId = getCurrentProjectId();
        
        // Show detailed loading state
        confirmBtn.textContent = 'Analyzing...';
        confirmBtn.disabled = true;
        statusMessage.textContent = 'Starting analysis... This may take 2-3 minutes.';
        statusMessage.className = 'status-message status-info';
        statusMessage.style.display = 'block';
        
        try {
          const response = await fetch('/projects/analyze-youtube', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              channel_url: channelUrl,
              project_id: projectId
            })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showStatus(`✓ Analysis completed! Analyzed ${result.data.total_comments.toLocaleString()} comments from ${result.data.videos_analyzed} videos.`, 'success');
            
            // Store analysis results
            sessionStorage.setItem('youtubeAnalysis', JSON.stringify(result.data));
            
            // Enable all analysis cards
            enableAnalysisCards();
            
            // Show current session
            await loadCurrentSession();
            
            // Update button state
            confirmBtn.textContent = 'Analyzed ✓';
            confirmBtn.classList.add('confirmed');
            
            // Status message only, no redirect
          } else {
            showStatus(`❌ Analysis failed: ${result.error}`, 'error');
            confirmBtn.textContent = 'Try Again';
            confirmBtn.disabled = false;
          }
          
        } catch (error) {
          console.error('Analysis error:', error);
          showStatus('❌ Connection error. Please check your internet and try again.', 'error');
          confirmBtn.textContent = 'Try Again';
          confirmBtn.disabled = false;
        }
      }
      
      // Load current session from server
      async function loadCurrentSession() {
        try {
          const projectId = getCurrentProjectId();
          const response = await fetch(`/projects/${projectId}/current-session`);
          const session = await response.json();
          
          if (session && session.channel_title) {
            showCurrentSession(session);
            return true;
          }
          return false;
        } catch (error) {
          console.error('Error loading session:', error);
          return false;
        }
      }
      
      function showCurrentSession(session) {
        const sessionDisplay = document.getElementById('currentSession');
        const urlInputSection = document.getElementById('urlInputSection');
        const title = document.getElementById('currentAnalysisTitle');
        const desc = document.getElementById('currentAnalysisDesc');
        
        document.getElementById('sessionChannel').textContent = 
          `Currently analyzing: ${session.channel_title}`;
        
        sessionDisplay.style.display = 'block';
        urlInputSection.style.display = 'none';
        
        title.textContent = 'Analysis Ready!';
        desc.textContent = `You're analyzing "${session.channel_title}". Select an analysis type below.`;
        
        // Enable all analysis cards
        enableAnalysisCards();
        
        // Store project ID for analysis pages
        const projectId = getCurrentProjectId();
        localStorage.setItem('currentProjectId', projectId);
      }
      
      async function clearCurrentSession() {
        if (!confirm('Clear current analysis session? You\'ll need to re-analyze to view results.')) {
          return;
        }
        
        try {
          const projectId = getCurrentProjectId();
          const response = await fetch(`/projects/${projectId}/clear-session`, {
            method: 'POST'
          });
        
          if (response.ok) {
            const sessionDisplay = document.getElementById('currentSession');
            const urlInputSection = document.getElementById('urlInputSection');
            const title = document.getElementById('currentAnalysisTitle');
            const desc = document.getElementById('currentAnalysisDesc');
            
            sessionDisplay.style.display = 'none';
            urlInputSection.style.display = 'block';
            
            title.textContent = 'Enter Data Source';
            desc.textContent = 'Paste the URL of the YouTube channel you want to analyze';
            
            // Disable analysis cards
            document.querySelectorAll('.analysis-card').forEach(card => {
              card.classList.add('disabled');
            });
            
            document.querySelectorAll('.analysis-link').forEach(link => {
              link.classList.add('disabled');
            });
            
            // Clear stored project ID
            localStorage.removeItem('currentProjectId');
            sessionStorage.removeItem('youtubeAnalysis');
            
            showStatus('Session cleared. Enter a new channel URL to analyze.', 'info');
          }
        } catch (error) {
          console.error('Error clearing session:', error);
          showStatus('Error clearing session', 'error');
        }
      }
      
      // JavaScript function to append project ID to links
      function addProjectIdToLink(linkElement) {
        // If card is disabled, prevent navigation
        if (linkElement.classList.contains('disabled')) {
          showStatus('Please analyze a YouTube channel first', 'error');
          return false;
        }
        
        const projectId = getCurrentProjectId();
        if (projectId) {
          const currentHref = linkElement.getAttribute('href');
          const separator = currentHref.includes('?') ? '&' : '?';
          linkElement.setAttribute('href', `${currentHref}${separator}project_id=${projectId}`);
          
          // Store in localStorage for the analysis page to use
          localStorage.setItem('currentProjectId', projectId);
        }
        return true;
      }
      
      // Function to enable analysis cards
      function enableAnalysisCards() {
        const analysisCards = document.querySelectorAll('.analysis-card');
        const analysisLinks = document.querySelectorAll('.analysis-link');
        
        analysisCards.forEach(card => {
          card.classList.remove('disabled');
        });
        
        analysisLinks.forEach(link => {
          link.classList.remove('disabled');
          // Add click handler to append project ID
          link.onclick = function(e) {
            return addProjectIdToLink(this);
          };
        });
      }
      
      function isValidYouTubeUrl(url) {
        const patterns = [
          /youtube\.com\/channel\//,
          /youtube\.com\/@/,
          /youtube\.com\/user\//,
          /youtube\.com\/c\//
        ];
        return patterns.some(pattern => pattern.test(url));
      }
      
      // Helper function to get project ID
      function getCurrentProjectId() {
        const projectData = document.getElementById('projectData');
        return projectData ? projectData.dataset.projectId : 1; // Default to 1
      }
      
      function showStatus(message, type) {
        const statusMessage = document.getElementById('statusMessage');
        statusMessage.textContent = message;
        statusMessage.className = 'status-message';
        statusMessage.classList.add(`status-${type}`);
        statusMessage.style.display = 'block';
        
        // Auto-hide success messages after 8 seconds
        if (type === 'success') {
          setTimeout(() => {
            if (statusMessage.textContent.includes('✓ Analysis completed!')) {
              // Don't hide if we're showing success message with data
              return;
            }
            statusMessage.style.display = 'none';
          }, 8000);
        }
      }
      
      document.addEventListener('DOMContentLoaded', function() {
        const urlInput = document.getElementById('youtubeUrl');
        const confirmBtn = document.getElementById('confirmBtn');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const analysisLinks = document.querySelectorAll('.analysis-link');
        const analysisCards = document.querySelectorAll('.analysis-card');
        const clearSessionBtn = document.getElementById('clearSessionBtn');
        
        // Load current session on page load
        loadCurrentSession();
        
        // Add event listener for clear session button
        if (clearSessionBtn) {
          clearSessionBtn.addEventListener('click', clearCurrentSession);
        }
        
        // Add event listener for confirm button - now using analyzeYouTubeChannel
        confirmBtn.addEventListener('click', function() {
          const activeTab = document.querySelector('.tab-btn.active').dataset.source;
          
          if (activeTab === 'youtube') {
            analyzeYouTubeChannel();
          } else {
            // Handle CSV upload (simulate processing for now)
            showStatus('CSV upload functionality coming soon!', 'error');
          }
        });
        
        // Tab selection
        tabBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            tabBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            const source = this.dataset.source;
            updatePlaceholder(source);
            
            // Clear status and reset button when changing tabs
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.style.display = 'none';
            confirmBtn.textContent = 'Analyze';
            confirmBtn.classList.remove('confirmed');
            confirmBtn.disabled = false;
          });
        });
        
        function updatePlaceholder(source) {
          switch(source) {
            case 'youtube':
              urlInput.placeholder = 'https://www.youtube.com/@ChannelName or https://www.youtube.com/c/ChannelName';
              break;
            case 'csv':
              urlInput.placeholder = 'Drag and drop CSV file or paste file path';
              break;
          }
        }
        
        // Clear status when user starts typing
        urlInput.addEventListener('input', function() {
          const statusMessage = document.getElementById('statusMessage');
          statusMessage.style.display = 'none';
          confirmBtn.textContent = 'Analyze';
          confirmBtn.classList.remove('confirmed');
          confirmBtn.disabled = false;
          
          // Disable analysis cards if URL is cleared
          if (!this.value.trim()) {
            analysisCards.forEach(card => {
              card.classList.add('disabled');
            });
            
            analysisLinks.forEach(link => {
              link.classList.add('disabled');
            });
          }
        });
        
        // Keyboard shortcut: Enter to confirm
        urlInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            confirmBtn.click();
          }
        });
        
        // Initialize with YouTube placeholder
        updatePlaceholder('youtube');
        
        // Add click handler for analysis cards (for visual feedback)
        analysisCards.forEach(card => {
          card.addEventListener('click', function(e) {
            // Only trigger if not disabled and not clicking on the link itself
            if (!this.classList.contains('disabled') && e.target !== this.querySelector('.analysis-link')) {
              const link = this.querySelector('.analysis-link');
              if (link && !link.classList.contains('disabled')) {
                // Add visual feedback before navigation
                this.style.transform = 'scale(0.98)';
                setTimeout(() => {
                  this.style.transform = '';
                }, 200);
              }
            }
          });
        });
        
        // Check if we have analysis results from session storage
        const youtubeAnalysis = sessionStorage.getItem('youtubeAnalysis');
        if (youtubeAnalysis) {
          try {
            const data = JSON.parse(youtubeAnalysis);
            if (data.total_comments) {
              // Enable analysis cards if we have stored results
              enableAnalysisCards();
              confirmBtn.textContent = 'Analyzed ✓';
              confirmBtn.classList.add('confirmed');
              
              // Show analysis summary
              showStatus(`✓ Analysis ready! ${data.total_comments.toLocaleString()} comments from ${data.videos_analyzed || 'multiple'} videos analyzed.`, 'success');
            }
          } catch (e) {
            console.error('Error parsing stored analysis:', e);
          }
        }
      });
    </script>
  </body>
</html>