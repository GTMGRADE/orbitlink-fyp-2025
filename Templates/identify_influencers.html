<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Identify Key Influencers - Project SNA</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        background: #0f1c3d;
        color: #fff;
        min-height: 100vh;
      }
      .layout {
        display: grid;
        grid-template-columns: 240px 1fr;
        min-height: 100vh;
      }
      .sidebar {
        background: #f24822;
        padding: 1rem 0.8rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .brand {
        font-weight: 800;
        font-size: 1.4rem;
        margin: 0.5rem 0.4rem;
      }
      .create-btn {
        background: #14294a;
        color: #fff;
        border-radius: 16px;
        padding: 1rem;
        text-align: center;
        font-weight: 800;
      }
      .create-btn a {
        color: #fff;
        text-decoration: none;
      }
      .menu {
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
      .menu a {
        display: block;
        padding: 0.7rem 0.8rem;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        text-decoration: none;
        border-radius: 6px;
        font-style: italic;
      }
      .menu a.active {
        background: rgba(255, 255, 255, 0.25);
      }
      .content {
        background: #0f1c3d;
        padding: 2rem;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      .title {
        font-size: 1.8rem;
        font-weight: 800;
      }
      .header-buttons {
        display: flex;
        gap: 0.8rem;
      }
      .header-buttons a {
        background: #ff3333;
        color: #000;
        border-radius: 6px;
        padding: 0.7rem 1.5rem;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
      }
      .header-buttons a:hover {
        background: #cc0000;
        transform: translateY(-3px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }
      .container {
        background: linear-gradient(135deg, #1a3a52 0%, #14294a 100%);
        padding: 2rem;
        border-radius: 16px;
        max-width: 1000px;
        margin: 0 auto;
      }
      
      /* Analysis Results Header */
      .results-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      }
      .channel-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
      }
      .channel-stats {
        color: rgba(255, 255, 255, 0.8);
        font-size: 0.9rem;
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        flex-wrap: wrap;
      }
      .channel-stats span {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
      }
      
      .page-title {
        font-size: 2rem;
        font-weight: 900;
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }
      .influencer-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }
      .influencer-card {
        background: #1e3a52;
        border-radius: 12px;
        padding: 1.8rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 1.5rem;
        align-items: start;
        transition: all 0.3s ease;
      }
      .influencer-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        border-color: rgba(255, 255, 255, 0.2);
      }
      
      .avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.5rem;
        font-weight: 700;
      }
      .avatar.yellow {
        background: linear-gradient(135deg, #ffaa00 0%, #ffdd99 100%);
      }
      .avatar.cyan {
        background: linear-gradient(135deg, #00ddff 0%, #99ffff 100%);
      }
      .avatar.default {
        background: linear-gradient(135deg, #9966cc 0%, #ccccff 100%);
      }
      
      .influencer-info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .influencer-details {
        flex: 1;
      }
      .influencer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
      }
      .influencer-name {
        font-size: 1.3rem;
        font-weight: 700;
      }
      .influencer-score {
        font-size: 1.6rem;
        font-weight: 900;
      }
      
      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-bottom: 0.8rem;
      }
      .stats-grid-2 {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }
      .stat-item {
        text-align: center;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
      }
      .stat-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 0.2rem;
      }
      .stat-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
      }
      
      /* Score Tags */
      .score-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }
      .score-tag {
        padding: 0.3rem 0.6rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      /* Visuals Section */
      .visuals-section {
        margin-top: 2rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 14px;
      }
      .visuals-title {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 1rem;
      }
      .visuals-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
      .chart-card {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
      }
      .chart-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 0.8rem;
      }
      .chart-description {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        line-height: 1.4;
        margin-bottom: 1rem;
        padding: 0.6rem;
        background: rgba(255, 255, 255, 0.02);
        border-left: 3px solid rgba(168, 85, 247, 0.5);
        border-radius: 4px;
      }
      .bar-row {
        display: grid;
        grid-template-columns: 120px 1fr 50px;
        gap: 0.6rem;
        align-items: center;
        margin-bottom: 0.6rem;
      }
      .bar-label {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .bar-track {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 10px;
        height: 10px;
        overflow: hidden;
      }
      .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #ff3333, #ffa500);
        border-radius: 10px;
      }
      .bar-value {
        text-align: right;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }
      .metric-rows {
        display: grid;
        gap: 0.6rem;
      }
      .metric-row {
        display: grid;
        grid-template-columns: 140px 1fr 60px;
        gap: 0.6rem;
        align-items: center;
      }
      .metrics-table {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .metrics-influencer {
        background: rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        padding: 1rem;
      }
      .metrics-influencer-name {
        font-weight: 600;
        color: rgba(255, 255, 255, 0.95);
        margin-bottom: 0.8rem;
        font-size: 0.95rem;
      }
      .metrics-bar-row {
        display: grid;
        grid-template-columns: 80px 1fr 60px;
        gap: 0.6rem;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .metrics-bar-row:last-child {
        margin-bottom: 0;
      }
      .metrics-bar-label {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
      }
      .metrics-bar-track {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 8px;
        height: 22px;
        overflow: hidden;
      }
      .metrics-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #a855f7, #9333ea);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 8px;
        color: white;
        font-size: 0.8rem;
        font-weight: 600;
        min-width: 30px;
      }
      .metrics-bar-value {
        text-align: right;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.85);
        font-variant-numeric: tabular-nums;
      }
      .metric-name {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }
      .metric-value {
        text-align: right;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }
      .scatter-wrap {
        width: 100%;
        height: 240px;
      }
      .scatter-wrap svg {
        width: 100%;
        height: 100%;
      }
      .axis-label {
        fill: rgba(255, 255, 255, 0.7);
        font-size: 11px;
      }
      .pie-wrap {
        display: grid;
        grid-template-columns: 160px 1fr;
        gap: 1rem;
        align-items: center;
      }
      .pie-legend {
        display: grid;
        gap: 0.4rem;
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }
      
      /* Loading State */
      .loading-state {
        text-align: center;
        padding: 3rem;
        color: rgba(255, 255, 255, 0.7);
      }
      .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid rgba(255, 255, 255, 0.1);
        border-top-color: #f24822;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      /* No Data State */
      .no-data {
        text-align: center;
        padding: 3rem;
        color: rgba(255, 255, 255, 0.7);
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 2px dashed rgba(255, 255, 255, 0.1);
      }
      
      /* Analysis Summary */
      .analysis-summary {
        text-align: center;
        margin: 2rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
      }
      .analysis-summary p {
        color: rgba(255, 255, 255, 0.8);
      }
      
      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .influencer-card {
          grid-template-columns: 1fr;
          text-align: center;
        }
        .avatar {
          width: 60px;
          height: 60px;
          font-size: 1.8rem;
          margin: 0 auto;
        }
        .influencer-header {
          flex-direction: column;
          gap: 0.5rem;
        }
        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .stats-grid-2 {
          grid-template-columns: 1fr;
        }
        .score-tags {
          justify-content: center;
        }
        .channel-stats {
          flex-direction: column;
          align-items: center;
          gap: 0.5rem;
        }
        .visuals-grid {
          grid-template-columns: 1fr;
        }
        .bar-row {
          grid-template-columns: 1fr;
          gap: 0.3rem;
        }
        .bar-value {
          text-align: left;
        }
        .metrics-header,
        .metrics-row {
          grid-template-columns: 1fr 1fr;
        }
        .metrics-header div:nth-child(3),
        .metrics-header div:nth-child(4),
        .metrics-row div:nth-child(3),
        .metrics-row div:nth-child(4) {
          display: none;
        }
      }
      
      @media (max-width: 480px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
        .avatar {
          width: 50px;
          height: 50px;
          font-size: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">OrbitLink</div>
        <!-- <div class="create-btn">
          <a href="{{ url_for('projects.projects_create_get') }}">Create +</a>
        </div> -->
        <nav class="menu">
          <a href="{{ url_for('projects.dashboard') }}">Dashboard</a>
          <!-- <a href="{{ url_for('projects.projects_list') }}">Projects</a> -->
          <!-- <a href="{{ url_for('projects.project_sna') }}">Analysis</a> -->
          <a href="#">Support</a>
          <a href="#">Setting</a>
        </nav>
      </aside>

      <main class="content">
        <div class="header">
          <div class="title">Identify Key Influencers</div>
          <!-- <div class="header-buttons">
            <a href="{{ url_for('projects.project_sna') }}">Back</a>
          </div> -->
          <div class="header-buttons">
              <!-- <a href="{{ url_for('projects.project_sna') }}?project_id={{ request.args.get('project_id', 1) }}"  -->
              <a href="{{ url_for('projects.project_sna') }}?project_id={{ request.args.get('project_id', '') }}" 
                class="back-button">Back</a>
          </div>
        </div>

        <div class="container">
          <!-- Analysis Results Header (Hidden by default) -->
          <div id="analysisResults" class="results-header" style="display: none;">
            <h2 id="channelTitle" class="channel-title"></h2>
            <div id="channelStats" class="channel-stats"></div>
          </div>
          
          <!-- Loading indicator -->
          <div id="loadingIndicator" class="loading-state" style="display: none;">
            <div class="spinner"></div>
            <p>Loading influencer data...</p>
          </div>
          
          <h1 class="page-title">Key Influencers</h1>
          
          <div class="influencer-list" id="influencerList">
            <!-- Default hardcoded influencers (fallback content) -->
            <div class="influencer-card">
              <div class="avatar yellow">ðŸ‘¤</div>
              <div class="influencer-info">
                <div class="influencer-header">
                  <div class="influencer-name">Tony Lee</div>
                  <div class="influencer-score" style="color: #ffa500;">88 pts</div>
                </div>
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-label">Comments</div>
                    <div class="stat-value">24</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Likes</div>
                    <div class="stat-value">1.2K</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Replies Received</div>
                    <div class="stat-value">15</div>
                  </div>
                </div>
                <div class="stats-grid-2">
                  <div class="stat-item">
                    <div class="stat-label">Videos Participated</div>
                    <div class="stat-value">8</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Threads Started</div>
                    <div class="stat-value">3</div>
                  </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                  <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem;">
                    Score Breakdown:
                  </div>
                  <div class="score-tags">
                    <span class="score-tag" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b;">
                      Engagement: 8.5
                    </span>
                    <span class="score-tag" style="background: rgba(107, 203, 255, 0.2); color: #6bcbff;">
                      Network: 7.8
                    </span>
                    <span class="score-tag" style="background: rgba(107, 255, 152, 0.2); color: #6bff98;">
                      Quality: 9.2
                    </span>
                    <span class="score-tag" style="background: rgba(255, 203, 107, 0.2); color: #ffcb6b;">
                      Consistency: 8.0
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="influencer-card">
              <div class="avatar cyan">ðŸŸ¡</div>
              <div class="influencer-info">
                <div class="influencer-header">
                  <div class="influencer-name">AnnaEcoJourney</div>
                  <div class="influencer-score" style="color: #ffa500;">80 pts</div>
                </div>
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-label">Comments</div>
                    <div class="stat-value">18</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Likes</div>
                    <div class="stat-value">890</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Replies Received</div>
                    <div class="stat-value">12</div>
                  </div>
                </div>
                <div class="stats-grid-2">
                  <div class="stat-item">
                    <div class="stat-label">Videos Participated</div>
                    <div class="stat-value">6</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Threads Started</div>
                    <div class="stat-value">2</div>
                  </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                  <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem;">
                    Score Breakdown:
                  </div>
                  <div class="score-tags">
                    <span class="score-tag" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b;">
                      Engagement: 7.8
                    </span>
                    <span class="score-tag" style="background: rgba(107, 203, 255, 0.2); color: #6bcbff;">
                      Network: 7.2
                    </span>
                    <span class="score-tag" style="background: rgba(107, 255, 152, 0.2); color: #6bff98;">
                      Quality: 8.5
                    </span>
                    <span class="score-tag" style="background: rgba(255, 203, 107, 0.2); color: #ffcb6b;">
                      Consistency: 7.5
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="influencer-card">
              <div class="avatar default">ðŸ”·</div>
              <div class="influencer-info">
                <div class="influencer-header">
                  <div class="influencer-name">Dr. Fit Facts</div>
                  <div class="influencer-score" style="color: #ffa500;">77 pts</div>
                </div>
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-label">Comments</div>
                    <div class="stat-value">15</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Likes</div>
                    <div class="stat-value">720</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Replies Received</div>
                    <div class="stat-value">8</div>
                  </div>
                </div>
                <div class="stats-grid-2">
                  <div class="stat-item">
                    <div class="stat-label">Videos Participated</div>
                    <div class="stat-value">5</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-label">Threads Started</div>
                    <div class="stat-value">1</div>
                  </div>
                </div>
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                  <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem;">
                    Score Breakdown:
                  </div>
                  <div class="score-tags">
                    <span class="score-tag" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b;">
                      Engagement: 7.2
                    </span>
                    <span class="score-tag" style="background: rgba(107, 203, 255, 0.2); color: #6bcbff;">
                      Network: 6.8
                    </span>
                    <span class="score-tag" style="background: rgba(107, 255, 152, 0.2); color: #6bff98;">
                      Quality: 8.0
                    </span>
                    <span class="score-tag" style="background: rgba(255, 203, 107, 0.2); color: #ffcb6b;">
                      Consistency: 7.0
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="influencerVisuals" class="visuals-section" style="display: none;">
            <div class="visuals-title">Influencer Visuals</div>
            <div id="visualsContent" class="visuals-grid"></div>
          </div>
        </div>
      </main>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const influencerList = document.getElementById('influencerList');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const analysisResults = document.getElementById('analysisResults');
        const channelTitle = document.getElementById('channelTitle');
        const channelStats = document.getElementById('channelStats');
        
        // Show loading indicator initially
        loadingIndicator.style.display = 'block';
        
        // Get project ID from URL or localStorage
        const projectId = new URLSearchParams(window.location.search).get('project_id') || localStorage.getItem('currentProjectId');
        
        // Try to load project-specific analysis data from sessionStorage
        const projectAnalysis = sessionStorage.getItem(`youtubeAnalysis_${projectId}`);
        
        async function loadAnalysisData() {
          if (projectAnalysis) {
            try {
              const data = JSON.parse(projectAnalysis);
              displayAnalysis(data);
              return true;
            } catch (error) {
              console.error('Error parsing project analysis data:', error);
            }
          }
          
          // If no project-specific data, try to load from server session
          if (projectId) {
            try {
              const response = await fetch(`/projects/${projectId}/current-session`);
              const session = await response.json();
              
              if (session && session.analysis_data) {
                displayAnalysis(session.analysis_data);
                
                // Save to sessionStorage for future use
                sessionStorage.setItem(`youtubeAnalysis_${projectId}`, JSON.stringify(session.analysis_data));
                return true;
              }
            } catch (error) {
              console.error('Error loading session from server:', error);
            }
          }
          
          return false;
        }
        
        // Load analysis data
        loadAnalysisData().then(success => {
          if (!success) {
            showDefaultContent();
          }
        });
        
        function displayAnalysis(data) {
          loadingIndicator.style.display = 'none';
          
          if (data.success && data.channel_metadata) {
            // Show analysis results
            analysisResults.style.display = 'block';
            
            // Display channel info
            channelTitle.textContent = data.channel_metadata.title;
            channelStats.innerHTML = `
              <div style="display: flex; justify-content: center; gap: 1.5rem; margin-top: 0.5rem;">
                <span>ðŸ“Š Subscribers: ${data.channel_metadata.subscriber_count ? data.channel_metadata.subscriber_count.toLocaleString() : 'N/A'}</span>
                <span>ðŸŽ¬ Videos Analyzed: ${data.videos_analyzed || 'N/A'}</span>
                <span>ðŸ’¬ Comments Analyzed: ${data.total_comments ? data.total_comments.toLocaleString() : 'N/A'}</span>
              </div>
            `;
            
            // Display influencers
            displayInfluencers(data.influencers || [], data.total_comments || 0);
            
          } else {
            showDefaultContent();
          }
        }
        
        function displayInfluencers(influencers, totalComments) {
          if (!influencers || influencers.length === 0) {
            influencerList.innerHTML = `
              <div class="no-data">
                <h3 style="margin-bottom: 1rem; color: #ffa500;">No influencers detected</h3>
                <p>We couldn't identify any key influencers in the analyzed data.</p>
                <p style="margin-top: 1rem; font-size: 0.9rem; color: rgba(255, 255, 255, 0.5);">
                  Try analyzing a channel with more comments and engagement.
                </p>
              </div>
            `;
            const visualsSection = document.getElementById('influencerVisuals');
            if (visualsSection) {
              visualsSection.style.display = 'none';
            }
            return;
          }
          
          // Show only top 5
          const topInfluencers = influencers.slice(0, 5);
          
          let html = '';
          
          topInfluencers.forEach((influencer, index) => {
            const scoreColor = getScoreColor(influencer.total_score);
            const rank = index + 1;
            
            html += `
              <div class="influencer-card">
                <div class="avatar" style="background: ${getAvatarColor(rank)};">
                  ${rank}
                </div>
                <div class="influencer-info">
                  <div class="influencer-details">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                      <div class="influencer-name">${influencer.author_name || 'Unknown User'}</div>
                      <div class="influencer-score" style="color: ${scoreColor};">
                        ${influencer.total_score ? influencer.total_score.toFixed(2) : '0.00'} pts
                      </div>
                    </div>
                    <div style="margin-top: 0.8rem;">
                      <div class="stats-grid">
                        <div class="stat-item">
                          <div class="stat-label">Comments</div>
                          <div class="stat-value">${influencer.total_comments || 0}</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-label">Likes</div>
                          <div class="stat-value">${influencer.total_likes ? influencer.total_likes.toLocaleString() : '0'}</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-label">Replies Received</div>
                          <div class="stat-value">${influencer.total_replies_received || 0}</div>
                        </div>
                      </div>
                      
                      <div class="stats-grid-2">
                        <div class="stat-item">
                          <div class="stat-label">Videos Participated</div>
                          <div class="stat-value">${influencer.unique_videos || 0}</div>
                        </div>
                        <div class="stat-item">
                          <div class="stat-label">Threads Started</div>
                          <div class="stat-value">${influencer.thread_starts || 0}</div>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Score Breakdown -->
                    <div style="margin-top: 1.2rem; padding-top: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                      <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7); margin-bottom: 0.5rem;">
                        Score Breakdown:
                      </div>
                      <div class="score-tags">
                        <span class="score-tag" style="background: rgba(255, 107, 107, 0.2); color: #ff6b6b;">
                          Engagement: ${influencer.engagement_score ? influencer.engagement_score.toFixed(1) : '0.0'}
                        </span>
                        <span class="score-tag" style="background: rgba(107, 203, 255, 0.2); color: #6bcbff;">
                          Network: ${influencer.network_score ? influencer.network_score.toFixed(1) : '0.0'}
                        </span>
                        <span class="score-tag" style="background: rgba(107, 255, 152, 0.2); color: #6bff98;">
                          Quality: ${influencer.quality_score ? influencer.quality_score.toFixed(1) : '0.0'}
                        </span>
                        <span class="score-tag" style="background: rgba(255, 203, 107, 0.2); color: #ffcb6b;">
                          Consistency: ${influencer.consistency_score ? influencer.consistency_score.toFixed(1) : '0.0'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            `;
          });
          
          // Show summary
          html += `
            <div class="analysis-summary">
              <p>
                Analysis completed: ${topInfluencers.length} influencers identified from ${totalComments ? totalComments.toLocaleString() : '0'} comments
              </p>
              <p style="font-size: 0.9rem; margin-top: 0.5rem; color: rgba(255, 255, 255, 0.6);">
                Project ID: ${projectId || 'Not specified'}
              </p>
            </div>
          `;
          
          influencerList.innerHTML = html;

          renderVisuals(influencers);
        }

        function renderVisuals(influencers) {
          const visualsSection = document.getElementById('influencerVisuals');
          const visualsContent = document.getElementById('visualsContent');
          if (!visualsSection || !visualsContent) return;

          const topTen = influencers.slice(0, 10);
          const topFive = influencers.slice(0, 5);

          const maxScore = Math.max(...topTen.map(i => i.total_score || 0), 1);
          const maxComments = Math.max(...topTen.map(i => i.total_comments || 0), 1);
          const maxLikes = Math.max(...topTen.map(i => i.total_likes || 0), 1);
          const maxReplies = Math.max(...topTen.map(i => i.replies_received || i.total_replies_received || 0), 1);

          const scoreBars = topTen.map(i => {
            const value = i.total_score || 0;
            const width = Math.round((value / maxScore) * 100);
            return `
              <div class="bar-row">
                <div class="bar-label">${i.author_name || 'Unknown'}</div>
                <div class="bar-track"><div class="bar-fill" style="width: ${width}%;"></div></div>
                <div class="bar-value">${value.toFixed ? value.toFixed(1) : value}</div>
              </div>
            `;
          }).join('');

          const engagementRows = topFive.map(i => {
            const comments = i.total_comments || 0;
            const likes = i.total_likes || 0;
            const replies = i.replies_received || i.total_replies_received || 0;
            
            const commentsWidth = maxComments ? Math.round((comments / maxComments) * 100) : 0;
            const likesWidth = maxLikes ? Math.round((likes / maxLikes) * 100) : 0;
            const repliesWidth = maxReplies ? Math.round((replies / maxReplies) * 100) : 0;
            
            return `
              <div class="metrics-influencer">
                <div class="metrics-influencer-name">${i.author_name || 'Unknown'}</div>
                
                <div class="metrics-bar-row">
                  <div class="metrics-bar-label">Comments</div>
                  <div class="metrics-bar-track">
                    <div class="metrics-bar-fill" style="width: ${commentsWidth}%;"></div>
                  </div>
                  <div class="metrics-bar-value">${comments.toLocaleString ? comments.toLocaleString() : comments}</div>
                </div>
                
                <div class="metrics-bar-row">
                  <div class="metrics-bar-label">Likes</div>
                  <div class="metrics-bar-track">
                    <div class="metrics-bar-fill" style="width: ${likesWidth}%;"></div>
                  </div>
                  <div class="metrics-bar-value">${likes.toLocaleString ? likes.toLocaleString() : likes}</div>
                </div>
                
                <div class="metrics-bar-row">
                  <div class="metrics-bar-label">Replies</div>
                  <div class="metrics-bar-track">
                    <div class="metrics-bar-fill" style="width: ${repliesWidth}%;"></div>
                  </div>
                  <div class="metrics-bar-value">${replies.toLocaleString ? replies.toLocaleString() : replies}</div>
                </div>
              </div>
            `;
          }).join('');

          const components = [
            { key: 'engagement_score', label: 'Engagement' },
            { key: 'network_score', label: 'Network' },
            { key: 'quality_score', label: 'Quality' },
            { key: 'consistency_score', label: 'Consistency' }
          ];

          const avgScores = components.map(c => {
            const vals = topTen.map(i => i[c.key] || 0);
            const avg = vals.reduce((a, b) => a + b, 0) / Math.max(vals.length, 1);
            return { label: c.label, value: avg };
          });

          const compositionPie = buildPieSvg(avgScores);
          const scatterSvg = buildScatterSvg(topTen);

          visualsContent.innerHTML = `
            <div class="chart-card">
              <div class="chart-title">Top 10 Influencers by Score</div>
              <div class="chart-description">
                Overall influence score (0-10) based on engagement quality, network reach, content consistency, and community interaction. Higher scores indicate more influential community members.
              </div>
              ${scoreBars}
            </div>
            <div class="chart-card">
              <div class="chart-title">Engagement Metrics (Top 5)</div>
              <div class="chart-description">
                Detailed engagement breakdown showing total comments posted, likes received, and replies from others. These metrics reveal each influencer's activity level and community response.
              </div>
              <div class="metrics-table">
                ${engagementRows}
              </div>
            </div>
            <div class="chart-card" style="grid-column: 1 / -1;">
              <div class="chart-title">Average Score Composition</div>
              <div class="chart-description">
                Percentage breakdown of the four core scoring components averaged across top influencers. This shows which factors contribute most to overall influence scores.
              </div>
              ${compositionPie}
              <div style="height: 1px; background: rgba(255, 255, 255, 0.08); margin: 1rem 0;"></div>
              <div class="chart-title" style="margin-bottom: 0.6rem;">Video Participation vs Influence Score</div>
              <div class="chart-description">
                Scatter plot showing the relationship between how many unique videos each influencer comments on (x-axis) and their total influence score (y-axis). Colors indicate score ranges: green (8+), orange (6-8), red (<6).
              </div>
              <div class="scatter-wrap">${scatterSvg}</div>
            </div>
          `;

          visualsSection.style.display = 'block';
        }

        function buildScatterSvg(influencers) {
          const width = 800;
          const height = 280;
          const padLeft = 60;
          const padBottom = 50;
          const padTop = 20;
          const padRight = 20;

          const xs = influencers.map(i => i.unique_videos || 0);
          const ys = influencers.map(i => i.total_score || 0);
          const minX = 0;
          const maxX = Math.max(...xs, 10);
          const minY = 0;
          const maxY = 10;

          const plotW = width - padLeft - padRight;
          const plotH = height - padTop - padBottom;

          const scaleX = (v) => padLeft + ((v - minX) / (maxX - minX || 1)) * plotW;
          const scaleY = (v) => padTop + (1 - (v - minY) / (maxY - minY || 1)) * plotH;

          // Y-axis grid lines (horizontal) for influence score
          const gridLines = [0, 2, 4, 6, 8, 10].map(t => {
            const y = scaleY(t);
            return `
              <line x1="${padLeft}" y1="${y}" x2="${width - padRight}" y2="${y}" stroke="rgba(255,255,255,0.08)" stroke-dasharray="3,3" />
              <text x="${padLeft - 10}" y="${y + 4}" text-anchor="end" class="axis-label" style="font-size: 11px; fill: rgba(255,255,255,0.6);">${t}</text>
            `;
          }).join('');

          // X-axis ticks - show every 2 videos for cleaner look
          const xTickInterval = Math.ceil(maxX / 10);
          const xTicks = [];
          for (let i = 0; i <= maxX; i += Math.max(1, xTickInterval)) {
            xTicks.push(i);
          }
          
          const xLabels = xTicks.map(t => {
            const x = scaleX(t);
            return `
              <line x1="${x}" y1="${height - padBottom}" x2="${x}" y2="${height - padBottom + 5}" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" />
              <text x="${x}" y="${height - padBottom + 20}" text-anchor="middle" class="axis-label" style="font-size: 11px; fill: rgba(255,255,255,0.6);">${t}</text>
            `;
          }).join('');

          const points = influencers.map(i => {
            const x = scaleX(i.unique_videos || 0);
            const y = scaleY(i.total_score || 0);
            const label = (i.author_name || 'Unknown');
            const displayName = label.length > 15 ? label.slice(0, 15) + '...' : label;
            const score = i.total_score || 0;
            const color = score >= 8 ? '#00ff99' : score >= 6 ? '#ffa500' : '#ff6b6b';
            return `
              <circle cx="${x}" cy="${y}" r="6" fill="${color}" stroke="rgba(255,255,255,0.3)" stroke-width="1.5" opacity="0.85">
                <title>${label} Â· Videos: ${i.unique_videos || 0} Â· Score: ${score.toFixed(2)}</title>
              </circle>
              <text x="${x + 10}" y="${y + 4}" style="font-size: 10px; fill: rgba(255,255,255,0.75); font-weight: 500;">${displayName}</text>
            `;
          }).join('');

          return `
            <svg viewBox="0 0 ${width} ${height}" preserveAspectRatio="xMidYMid meet" aria-label="Scatter plot" style="overflow: visible;">
              ${gridLines}
              
              <!-- Main axes -->
              <line x1="${padLeft}" y1="${height - padBottom}" x2="${width - padRight}" y2="${height - padBottom}" stroke="rgba(255,255,255,0.4)" stroke-width="2" />
              <line x1="${padLeft}" y1="${padTop}" x2="${padLeft}" y2="${height - padBottom}" stroke="rgba(255,255,255,0.4)" stroke-width="2" />
              
              ${xLabels}
              ${points}
              
              <!-- Axis labels -->
              <text x="${width / 2}" y="${height - 8}" text-anchor="middle" class="axis-label" style="font-size: 13px; font-weight: 600; fill: rgba(255,255,255,0.8);">Number of Unique Videos Commented On</text>
              <text x="20" y="${height / 2}" text-anchor="middle" class="axis-label" style="font-size: 13px; font-weight: 600; fill: rgba(255,255,255,0.8);" transform="rotate(-90 20 ${height / 2})">Influence Score (0-10)</text>
            </svg>
          `;
        }

        function buildPieSvg(segments) {
          const total = segments.reduce((s, d) => s + d.value, 0) || 1;
          const colors = ['#ff3333', '#ffa500', '#00f2fe', '#6bff98', '#6bcbff', '#ff6b6b'];
          let current = 0;

          const arcs = segments.map((d, i) => {
            const fraction = d.value / total;
            const start = current * 2 * Math.PI;
            const end = (current + fraction) * 2 * Math.PI;
            current += fraction;

            const x1 = Math.cos(start);
            const y1 = Math.sin(start);
            const x2 = Math.cos(end);
            const y2 = Math.sin(end);
            const largeArc = fraction > 0.5 ? 1 : 0;
            const path = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArc} 1 ${x2} ${y2} Z`;
            return `<path d="${path}" fill="${colors[i % colors.length]}" />`;
          }).join('');

          const legend = segments.map((d, i) => {
            const percent = (d.value / total) * 100;
            return `
              <div class="legend-item">
                <span class="legend-dot" style="background: ${colors[i % colors.length]};"></span>
                <span>${d.label} (${percent.toFixed(1)}%)</span>
              </div>
            `;
          }).join('');

          return `
            <div class="pie-wrap">
              <svg viewBox="-1.1 -1.1 2.2 2.2" width="160" height="160" aria-label="Average score composition">
                ${arcs}
                <circle cx="0" cy="0" r="0.45" fill="#0f1c3d"></circle>
              </svg>
              <div class="pie-legend">
                ${legend}
              </div>
            </div>
          `;
        }
        
        function showDefaultContent() {
          // Show default hardcoded influencers if no analysis data
          loadingIndicator.style.display = 'none';
          // Keep the default content that's already in the HTML
        }
        
        function getScoreColor(score) {
          // Match Colab color scheme: 0-10 scale
          if (score >= 8) return '#00ff00';  // Green for high scores
          if (score >= 6) return '#ffa500';  // Orange for medium
          if (score >= 4) return '#ffff00';  // Yellow
          return '#ff3333';  // Red for low scores
        }
        
        function getAvatarColor(rank) {
          // Simple color scheme, no medals
          const colors = [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
          ];
          return colors[rank - 1] || colors[0];
        }
      });
    </script>
  </body>
</html>